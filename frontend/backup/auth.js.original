// AUTH.JS MÃNIMO Y FUNCIONAL
console.log("âœ… auth.js cargado");

class AuthManager {
    constructor() {
        console.log("âœ… AuthManager creado");
        this.apiGateway = "http://localhost:3000/api";
    }

    async login(email, password) {
        console.log("ğŸ” Login intentado:", email);
        try {
            const response = await fetch(this.apiGateway + "/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            });

            console.log("ğŸ“Š Status:", response.status);

            if (!response.ok) {
                const error = await response.json();
                return { success: false, error: error.error };
            }

            const data = await response.json();
            console.log("âœ… Login exitoso");

            // Guardar
            localStorage.setItem("jtx_token", data.token);
            localStorage.setItem("jtx_user", JSON.stringify(data.user));

            alert("âœ… Â¡Login exitoso!");
            setTimeout(() => location.reload(), 1000);

            return { success: true, data };
        } catch (error) {
            console.error("âŒ Error:", error);
            return { success: false, error: error.message };
        }
    }
}

// Â¡Â¡Â¡PARTE CRÃTICA - ASIGNAR A WINDOW!!!
console.log("ğŸ”§ Asignando window.auth...");
window.auth = new AuthManager();
console.log("âœ… window.auth asignado:", !!window.auth);

// FunciÃ³n para formulario
window.showLoginForm = function() {
    console.log("ğŸ“ Mostrando formulario...");
    const authForms = document.getElementById("auth-forms");
    if (authForms) {
        authForms.innerHTML = `
            <h3>Iniciar SesiÃ³n</h3>
            <div style="margin: 20px 0;">
                <input type="email" id="email" value="admin@jtx.com" style="padding: 10px; margin: 5px;">
                <input type="password" id="password" value="admin123" style="padding: 10px; margin: 5px;">
                <button id="login-btn" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px;">
                    Iniciar SesiÃ³n
                </button>
            </div>
        `;

        document.getElementById("login-btn").onclick = async function() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            console.log("ğŸ–±ï¸ BotÃ³n clickeado:", email);
            if (window.auth && window.auth.login) {
                const result = await window.auth.login(email, password);
                console.log("Resultado:", result);
            } else {
                alert("âŒ ERROR: auth no disponible");
            }
        };
    }
};

// Ejecutar al cargar
console.log("â³ Configurando carga automÃ¡tica...");
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
        console.log("âœ… DOM cargado");
        window.showLoginForm();
    });
} else {
    console.log("âœ… DOM ya cargado");
    setTimeout(() => window.showLoginForm(), 100);
}

console.log("âœ… auth.js completamente cargado");
